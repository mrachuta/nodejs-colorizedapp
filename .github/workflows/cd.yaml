name: CD build
run-name: CD job triggered by ${{ github.triggering_actor }} for ${{ github.ref_name }}
on: [workflow_dispatch]

jobs:
  call-ci-workflow:
    uses: ./.github/workflows/ci.yaml
  build_image:
    needs: call-ci-workflow
    runs-on: ubuntu-latest
    steps:
      - name: Checkout to specific branch or commit
        uses: actions/checkout@v4

      - name: Create image tag
        id: customvars
        run: echo "image_tag=${GITHUB_REF_NAME//\//_}-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Check outputs
        run: echo ${{ steps.customvars.outputs.image_tag }}

      - name: Build an image from Dockerfile
        run: |
          docker build . -t ${{ vars.ACR_ADDRESS }}/nodejs-colorizedapp:${{ steps.customvars.outputs.image_tag }}

      - name: SCA Scan (docker image)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: '${{ vars.ACR_ADDRESS }}/nodejs-colorizedapp:${{ steps.customvars.outputs.image_tag }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '1'
          scanners: 'vuln,secret,config'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: SCA

      - name: Login to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          # Global variable in GH
          login-server: ${{ vars.ACR_ADDRESS }}
          # Secrets in GH
          username: ${{ secrets.ACR_LOGIN }}
          password: ${{ secrets.ACR_PASS }}

      - name: Push image to Azure Container Registry
        run: |
          docker push ${{ vars.ACR_ADDRESS }}/nodejs-colorizedapp:${{ steps.customvars.outputs.image_tag }}
